# EDI・注文管理システム (EDI-MP)

本システムは、自社と取引先（パートナー）の間で、基本契約から発注、請求、支払通知までの一連の業務を完全デジタル化し、効率化するためのポータルサイトです。

(日高　テストで追記しています。テストテキスト)


## 1. 主な機能と実装ステータス

- **パートナーオンボーディング**: 取引先による会社情報、インボイス登録番号、振込先情報のオンライン登録。
- **デジタル発注フロー**:
    - **下書き (DRAFT)**: 管理者による発注データ作成。
    - **正式発行 (PUBLISH)**: パートナーへの公開。
    - **オンライン受領・承認**: パートナーによる内容確認と承認。
- **電帳法・インボイス制度対応**:
    - 適格請求書発行事業者番号（T番号）の管理とバリデーション。
    - 注文書・注文請書のPDF永続保存（Immutable Archives）および改ざん防止ハッシュの生成。
    - 確定日時のタイムスタンプ保持。
- **外部電子署名連携 (Phase 4)**: 外部署名サービスとのAPI連携およびWebhookによる自動ステータス更新。

## 2. システムの起動方法

### ステップ1: 環境構築
1. 仮想環境の有効化:
   ```bash
   source .venv/bin/activate
   ```
2. 依存パッケージのインストール:
   ```bash
   pip install -r requirements.txt
   ```
3. データベースマイグレーション:
   ```bash
   python manage.py migrate
   ```

### ステップ2: 開発サーバーの起動
```bash
python manage.py runserver
```

### ステップ3: アクセス
- **フロントエンド（各ユーザー用）**: [http://127.0.0.1:8000/](http://127.0.0.1:8000/)
- **管理者画面 (Django Admin)**: [http://127.0.0.1:8000/admin/](http://127.0.0.1:8000/admin/)

---

## 3. アカウントと運用フロー

### A. 管理者（自社ユーザー）
1. **初期登録**: `/signup/admin/` より登録（または `createsuperuser`）。
2. **発注管理**: 管理画面（Admin）または管理用ダッシュボードから発注データを作成。
3. **正式発行**: 作成した `DRAFT` 状態の注文書を「正式発行」し、取引先へ公開。

### B. 取引先（パートナーユーザー）
1. **アカウント発行**: 管理者が `Profile` と紐付けてアカウントを作成。
2. **オンボーディング**: ログイン後のダッシュボードから「会社情報を登録・更新する」をクリックし、インボイス登録番号や振込先口座情報を登録。
3. **注文の承認**: 届いた注文書の内容を確認し「承認」ボタンをクリック。承認と同時にシステムが「注文請書」を自動生成・保存。

---

## 4. 技術仕様とコンプライアンス

- **データ完全性**: 承認された文書（PDF）はサーバー上に永続保存され、SHA256ハッシュが生成されます。
- **マスタ管理**: `BankMaster` による正確な金融機関データの選択をサポート。
- **外部連携 (SignatureService)**: `orders/services/signature_service.py` を通じて外部電子署名プロバイダーとの連携が可能。
- **Webhook受領**: `orders/webhooks.py` にて、外部サービスからの署名完了イベントを処理します。

---

## 5. 管理者向けのパスワード変更
1. ログイン中: `/accounts/password_change/`
2. 管理者画面: 「ユーザー」モデルから変更。
3. CLI: `python manage.py changepassword [ユーザー名]`
